# 邮件合并小工具(询证函) - 使用说明

## 一、软件概述

邮件合并小工具是一款专门用于将Excel数据合并到Word模板文档的工具，特别适用于询证函等批量文档的生成。它能保留Word文档中的所有格式，同时将Excel中的数据按照原格式插入到对应位置。

主要特点：

- 保留Excel数据格式（如日期、货币、前导零等）
- 保留Word模板中的文本格式
- 支持页眉、页脚、表格等位置的合并
- 可检查字段映射关系

## 二、软件架构

软件主要由以下几个模块组成：

### 1. 数据处理模块

- `format_cell_value()`: 根据Excel单元格格式对数据进行格式化
- `read_excel_with_format()`: 读取Excel数据并保留格式信息

### 2. Word模板处理模块

- `extract_placeholders()`: 提取Word模板中的所有占位符
- `replace_placeholders()`: 替换Word文档中的占位符并保留格式

### 3. 图形界面模块

- `MailMergeApp` 类: 处理用户交互和流程控制

## 三、工作流程

### 1. 数据读取与格式化

当用户选择Excel文件后，软件会执行以下操作：

1. 使用pandas读取Excel数据的基本结构
2. 使用openpyxl读取每个单元格的格式信息
3. 根据单元格格式信息处理数据，保留前导零、千分位、货币符号等特殊格式
4. 将格式化后的数据存储到内存中

### 2. Word模板分析

当用户选择Word模板文件后，软件会：

1. 解析模板，提取所有占位符（格式为`«字段名»`）
2. 检查这些占位符是否都有对应的Excel列
3. 向用户显示检查结果

### 3. 文档生成

当用户点击"开始合并生成文档"后：

1. 为每行Excel数据创建一个新的Word文档
2. 将格式化后的数据替换到对应的占位符位置
3. 使用带格式的Excel单元格值作为文件名，确保编号等保持原始格式
4. 保存文档到指定目录

## 四、关键技术点

### 1. Excel格式处理

软件能识别并处理多种Excel格式：

- 文本格式：保持原样，包括前导零
- 日期格式：根据是否包含时间使用不同的格式
- 货币格式：保留货币符号和千分位
- 数字格式：处理千分位和小数位数
- 百分比格式：保留百分号和小数位数

### 2. Word格式保留

在替换Word文档中的占位符时，软件能够：

- 识别跨越多个格式段(runs)的占位符
- 在替换时保留原有的字体、大小、颜色等格式
- 处理段落、表格、页眉页脚中的占位符

### 3. 文件名格式化

生成的文档文件名与Excel中显示的格式完全一致：

- 前导零保持不变（如001.docx而不是1.docx）
- 特殊格式（如千分位）也会保留

## 五、使用方法

### 准备工作

1. **Excel数据文件**
   - 第一行必须包含字段名（将作为Word模板中的占位符对应）
   - 每行包含一个目标文档的数据

2. **Word模板文件**
   - 在需要替换的位置插入占位符，格式为`«字段名»`
   - 字段名必须与Excel表头完全一致

### 操作步骤

1. 点击"选择Excel"按钮，选择准备好的Excel数据文件
2. 点击"选择Word模板"按钮，选择带有占位符的Word模板
3. 从下拉列表中选择用于命名生成文档的Excel列
4. (可选) 点击"选择输出文件夹"指定生成文档的保存位置
5. 点击"检查字段映射"按钮，检查Excel数据与Word模板的匹配情况
6. 点击"开始合并生成文档"开始批量生成文档

### 注意事项

1. 占位符大小写敏感，务必保证Excel表头与Word占位符完全一致
2. 如果有特殊格式要求的字段（如编号需要保留前导零），请在Excel中设置为文本格式
3. 默认输出目录为Excel文件同目录下的"output_docs"文件夹
4. 文件名中的非法字符（如/\:*?"<>|）会被自动替换为下划线

## 六、技术依赖

本软件依赖以下Python库：

- tkinter: 图形界面
- pandas: Excel数据处理
- openpyxl: Excel格式读取
- python-docx: Word文档处理
- numpy: 数值处理
- datetime: 日期时间处理
- re: 正则表达式处理

## 七、常见问题解答

1. **Q: 为什么生成的文档中数字格式不正确？**
   A: 请检查Excel中的单元格格式设置，软件会根据Excel中的设置生成对应格式。

2. **Q: 占位符无法替换怎么办？**
   A: 确保占位符格式为`«字段名»`，并且字段名与Excel表头完全一致。

3. **Q: 如何保证编号格式为"001"而不是"1"？**
   A: 在Excel中将该列设置为文本格式，或使用自定义数字格式"000"。

4. **Q: 如何在Word中插入占位符？**
   A: 直接在Word中输入`«字段名»`，或使用Word的邮件合并功能插入字段。

5. **Q: 文件名中有特殊字符怎么办？**
   A: 软件会自动将文件名中的非法字符替换为下划线，确保文件名有效。 
